

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>src.BayesReg &mdash; Stock Prediction API  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Stock Prediction API
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notes/LSTM.html">Understanding the LSTM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/GPM.html">Understanding the GPM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_build/modules.html">ml_stock_prediction_api</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Stock Prediction API</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>src.BayesReg</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for src.BayesReg</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Code for the Gaussian Process Model implementation.</span>

<span class="sd">@author: Shashank Swaminathan</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">tt</span>
<span class="kn">from</span> <span class="nn">src.get_data</span> <span class="k">import</span> <span class="n">Company</span>

<div class="viewcode-block" id="GPM"><a class="viewcode-back" href="../../_build/src.html#src.BayesReg.GPM">[docs]</a><span class="k">class</span> <span class="nc">GPM</span><span class="p">():</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class encapsulating Gaussian Process model implementation. Depends on the PyMC3 library.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="GPM.__init__"><a class="viewcode-back" href="../../_build/src.html#src.BayesReg.GPM.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">end_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        init function. Fetches and prepares data from desired ticker using Company class from accompanying get_data API. Assumes start and end dates of January 1st, 2000 -&gt; today.</span>

<span class="sd">        :param ticker: Ticker of stock to predict.</span>
<span class="sd">        :param start_date: Datetime object of when to start retrieving stock data. Defaults to 1/1/2000.</span>
<span class="sd">        :param end_date: Datetime object of when to stop retrieving stock data. Defaults to today&#39;s date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comp</span> <span class="o">=</span> <span class="n">Company</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_early</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_later</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_prep_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to prepare the data. Assumes an attribute named comp exists, and is a Company class.</span>

<span class="sd">        :returns: Dataframe of pruned data. Of form [times, normalized stock vals, raw stock vals]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">Date</span><span class="p">)</span>
        <span class="n">raw_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">return_numpy_array_of_company_daily_stock_close</span><span class="p">()</span>
        <span class="n">norm_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_y</span><span class="o">-</span><span class="n">raw_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">raw_y</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dates_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;norm_y&#39;</span><span class="p">:</span><span class="n">norm_y</span><span class="p">,</span> <span class="s1">&#39;raw_y&#39;</span><span class="p">:</span> <span class="n">raw_y</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<div class="viewcode-block" id="GPM.go"><a class="viewcode-back" href="../../_build/src.html#src.BayesReg.GPM.go">[docs]</a>    <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">split_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2019-09-30&quot;</span><span class="p">),</span><span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main function to train the model and predict future data. First generates training and testing data, then trains the GP on the training data. Finally, it predicts on the time range specified.</span>

<span class="sd">        :param start_date: Date to start training GP. If left as None, defaults to starting date of training data set.</span>
<span class="sd">        :param split_date: Date to end training.</span>
<span class="sd">        :param start_date: Date to end predicting using GP. If left as None, defaults to ending date of training data set. Assumes prediction starts right after training.</span>

<span class="sd">        :returns: A tuple of four arrays, containing the mean predictions, upper/lower bounds of predictions, training data, and test data for comparison. Predictions done on non business days are dropped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating data...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_test_train_data</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">split_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training GPM...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_gp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_gp</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating plot...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_vals</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_gen_test_train_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">split_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to generate the training and testing data.</span>

<span class="sd">        :param start_date: Date to start training GP. If left as None, defaults to starting date of training data set.</span>
<span class="sd">        :param split_date: Date to end training.</span>
<span class="sd">        :param start_date: Date to end predicting using GP. If left as None, defaults to ending date of training data set. Assumes prediction starts right after training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start_date</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">start_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
        <span class="k">if</span> <span class="n">end_date</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">end_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_start</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_end</span> <span class="o">=</span> <span class="n">end_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_date</span><span class="o">=</span><span class="n">split_date</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
        <span class="n">sep_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">split_date</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># Y-M-D</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_early</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">sep_idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_later</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sep_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">def</span> <span class="nf">_train_gp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to train the GP model. Uses a combo of 3 GPs, with ExpQuad, Rational, and Periodic kernels. Noise is modeled as a combo of WhiteNoise and a Matern32 kernel. MAP is stored in attribute named mp. Conditioned GP is stored in attribute named gp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
            <span class="c1"># yearly periodic component x long term trend</span>
            <span class="n">η_per</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="s2">&quot;η_per&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">period</span>  <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ℓ_psmooth</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s2">&quot;ℓ_psmooth &quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cov_seasonal</span> <span class="o">=</span> <span class="n">η_per</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">Periodic</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">ℓ_psmooth</span><span class="p">)</span>
            <span class="n">gp_seasonal</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Marginal</span><span class="p">(</span><span class="n">cov_func</span><span class="o">=</span><span class="n">cov_seasonal</span><span class="p">)</span>

            <span class="c1"># small/medium term irregularities</span>
            <span class="n">η_med</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="s2">&quot;η_med&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">ℓ_med</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s2">&quot;ℓ_med&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">α</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s2">&quot;α&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cov_medium</span> <span class="o">=</span> <span class="n">η_med</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">RatQuad</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ℓ_med</span><span class="p">,</span> <span class="n">α</span><span class="p">)</span>
            <span class="n">gp_medium</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Marginal</span><span class="p">(</span><span class="n">cov_func</span><span class="o">=</span><span class="n">cov_medium</span><span class="p">)</span>

            <span class="c1"># long term trend</span>
            <span class="n">η_trend</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="s2">&quot;η_trend&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">ℓ_trend</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s2">&quot;ℓ_trend&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cov_trend</span> <span class="o">=</span> <span class="n">η_trend</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">ExpQuad</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ℓ_trend</span><span class="p">)</span>
            <span class="n">gp_trend</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">Marginal</span><span class="p">(</span><span class="n">cov_func</span><span class="o">=</span><span class="n">cov_trend</span><span class="p">)</span>

            <span class="c1"># noise model</span>
            <span class="n">η_noise</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">&quot;η_noise&quot;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ℓ_noise</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s2">&quot;ℓ_noise&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">σ</span>  <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">&quot;σ&quot;</span><span class="p">,</span>  <span class="n">sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">cov_noise</span> <span class="o">=</span> <span class="n">η_noise</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">Matern32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ℓ_noise</span><span class="p">)</span> <span class="o">+</span>\
                        <span class="n">pm</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">WhiteNoise</span><span class="p">(</span><span class="n">σ</span><span class="p">)</span>

            <span class="c1"># The Gaussian process is a sum of these three components</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">gp_seasonal</span> <span class="o">+</span> <span class="n">gp_medium</span> <span class="o">+</span> <span class="n">gp_trend</span>

            <span class="c1"># Since the normal noise model and the GP are conjugates</span>
            <span class="c1"># We use `Marginal` with the `.marginal_likelihood` method</span>
            <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_early</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_early</span><span class="p">[</span><span class="s1">&#39;norm_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">marginal_likelihood</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">cov_noise</span><span class="p">)</span>

            <span class="c1"># this line calls an optimizer to find the MAP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">(</span><span class="n">include_transformed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict_gp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for predicting over specified range. Converts back from normalized values to actual values. Stores result of predictions in attribute named fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># predict at a 1 day granularity using generated datetime array.</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
        <span class="n">tnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dates_to_idx</span><span class="p">(</span><span class="n">dates</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">std_y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;raw_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">first_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;raw_y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predicting with GPM ...&quot;</span><span class="p">)</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tnew</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Convert back from normalized values to raw values.</span>
        <span class="n">mean_pred</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="n">std_y</span> <span class="o">+</span> <span class="n">first_y</span>
        <span class="n">var_pred</span>  <span class="o">=</span> <span class="n">var</span><span class="o">*</span><span class="n">std_y</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># make dataframe to store fit results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">tnew</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                 <span class="s2">&quot;mu_total&quot;</span><span class="p">:</span> <span class="n">mean_pred</span><span class="p">,</span>
                                 <span class="s2">&quot;sd_total&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_pred</span><span class="p">)},</span>
                                <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_plot_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to get useful values for plotting. Predictions done on non business days are dropped.</span>

<span class="sd">        :returns: A tuple of four arrays, containing the mean predictions, upper/lower bounds of predictions, training data, and test data for comparison.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span>

        <span class="c1"># Search for and remove predictions on non-business days from fit</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">l</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fit</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;1970-01-01T00:00:00Z&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">j</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>

        <span class="c1"># Generate upper and lower bound predictions, 2 std deviations away from mean.</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">mu_total</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">fit</span><span class="o">.</span><span class="n">sd_total</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">mu_total</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">fit</span><span class="o">.</span><span class="n">sd_total</span><span class="o">.</span><span class="n">values</span>
        <span class="n">band_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">band_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Generate output data.</span>
        <span class="n">xy_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">mu_total</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">sd_total</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">std_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">band_x</span><span class="p">,</span> <span class="n">band_y</span><span class="p">]</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_early</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_early</span><span class="p">[</span><span class="s1">&#39;raw_y&#39;</span><span class="p">]]</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_later</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_later</span><span class="p">[</span><span class="s1">&#39;raw_y&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">xy_pred</span><span class="p">,</span> <span class="n">std_bounds</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span>

    <span class="k">def</span> <span class="nf">_plot_stock_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">show_split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">raw_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">rg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function that plots stock data for desired ticker using Bokeh. Only useful in Jupyter Notebooks.</span>

<span class="sd">        :param show_split: If true, checks if training and testing data split has been generated. If so, will plot a yellowed region indicating split. If not, will generate warning. If false, will not do anything related.</span>
<span class="sd">        :param raw_data: If true, will plot raw data. If false, will plot normalized data.</span>
<span class="sd">        :param rg: Array of [start date, end date]. If left None, will default to starting date of stock value data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If no range specified, assume whole thing</span>
        <span class="k">if</span> <span class="n">rg</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">rg</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">]</span>
        <span class="c1"># Prep data to plot</span>
        <span class="n">s_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">e_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">rg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sel_dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_idx</span><span class="p">:</span><span class="n">e_idx</span><span class="p">,:]</span>
        <span class="n">t</span><span class="o">=</span><span class="n">sel_dat</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="n">raw_data</span><span class="p">:</span>
            <span class="n">y</span><span class="o">=</span><span class="n">sel_dat</span><span class="p">[</span><span class="s1">&#39;raw_y&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="o">=</span><span class="n">sel_dat</span><span class="p">[</span><span class="s1">&#39;norm_y&#39;</span><span class="p">]</span>
        <span class="c1"># Plot data</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Prices of &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">+</span><span class="s1">&#39; stock over time&#39;</span><span class="p">,</span>
                   <span class="n">x_range</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span> <span class="n">plot_width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="mi">573</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Stock price&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Date&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># Add box region to show test/train split</span>
        <span class="k">if</span> <span class="n">show_split</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_date</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Test/train split on data has not yet been performed.&#39;</span><span class="o">+</span>\
                          <span class="s1">&#39; Ignoring request for test region highlighting.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">show_split</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_date</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_region</span> <span class="o">=</span> <span class="n">BoxAnnotation</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_date</span><span class="p">,</span>
                               <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">predict_region</span><span class="p">)</span>
        <span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dates_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tlist</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to convert datetime objects into integers useful for training.</span>

<span class="sd">        :param tlist: Numpy array or Pandas Series of datetime objects.</span>

<span class="sd">        :returns: Numpy array of integers representing datetimes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reference_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlist</span> <span class="o">-</span> <span class="n">reference_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<span class="c1"># if __name__ == &quot;__main__&quot;:</span>
<span class="c1">#     cms = GPM(&#39;AAPL&#39;)</span>
<span class="c1">#     rg=[datetime(2019,7,31),datetime(2019,9,30),datetime(2019,10,31)]</span>
<span class="c1">#     cms.gen_test_train_data(start_date=rg[0],split_date=rg[1],end_date=rg[2])</span>
<span class="c1">#     cms.train_gp()</span>
<span class="c1">#     cms.predict_gp()</span>
<span class="c1">#     xy_pred, std_bounds, train_data, test_data = cms.get_plot_vals()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Duncan Mazza and Shashank Swaminathan

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>